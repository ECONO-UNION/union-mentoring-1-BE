# Deadlock

----

>## Mentor's Q
>
>### 1. 교착상태(Deadlock) 이란 무엇이고, 어떤 조건들이 갖춰진 경우에 발생하는 지 알려주세요.
>
>### 2. 자원 할당 그래프 (Resource Allocation Graph)를 사용해서 Deadlock을 표현해주세요
>
>### 3. Deadlock을 다루기 위한 방법(Ignorance, Prevention, ...)은 이와 같이 여러가지가 있는데 각각의 장단점은 무엇이고, 어떤 방법이 가장 많이 쓰이고 있는 지, 왜 많이 쓰이는 지 알려주세요.
>
>

-----

[toc]

## 1.  교착상태(Deadlock) 이란 무엇이고, 어떤 조건들이 갖춰진 경우에 발생하는 지 알려주세요.

모든 프로세스는 실행을 완료하기 위해서 리소스가 필요하다. 그러나 자원은 순차적으로 부여된다.

	1. 프로세스가 약간의 자원을 요청
	2. OS는 리소스가 가용상태에 있으면 승인, 가용할 수 없는 상태면 기다리도록 한다.
	3. 프로세스는 자원을 사용하고 완료가 되면 자원을 풀어준다.

교착상태는 각각의 프로세스들이 다른 리소스에 할당되어있는 리소스를 위해 기다리고 있는 상태이다. 

이 상황에서는 필요한 리소스가 다른 프로세스에서 사용중이라 기다리고 있는 상태라 프로세스가 실행되지 않는다.

프로세스가 3개와 리소스 3개가 있고( P1, P2, P3 , R1, R2, R3 )

R1은 P1에 R2는 P2에 R3는 P3에 할당되어 있다고 가정해보자

이 상황에서, P1은 P2에서 사용중인 R2를 요청한다면, P1은 R2가 없이는 프로세스를 완료할 수 없기 때문에 실행을 멈추게 된다.(대기) 그 상황에서 P2가 P3에서 사용 중인 R3를 요구 한다면, P2 또한 R3 없이 프로세스를 완료할 수 없기 때문에 실행을 멈추게 된다. (대기) 거기에 P3가 R1을 원한다면 ? 결국엔 3개의 프로세스 모두 멈춰있는 상태가 된다. 이 시나리오에서는 프로세스 사이에 주기가 형성된다. 진행중인 프로세스가 없게되고 모두 대기중인 상태가 된다. 모든 프로세스가 차단되게되고 컴퓨터는 응답하지 않게 된다.

![image-20210903172038064](/Users/samuel/Library/Application Support/typora-user-images/image-20210903172038064.png)

Deadlock은 앞서 배운 Starvation이랑은 차이점이 있다.

1. **교착상태**는 프로세스가 차단되지 않은 상황에서 프로세스가 진행되지 않는 것이지만, **기아현상**은 우선 순위가 낮은 프로세스가 차단되고, 우선순위가 높은 프로세스가 우선적으로 진행되는 상황이다.
2. 때문에 **교착상태**는 무한적으로 대기상태에 빠지게 되고, **기아현상**은 기다림이 길 수는 있지만 무한하지는 않다.

3. 모든 **교착상태**는 항상 기아현상이지만, 모든 **기아현상**이 교착 상태는 아니다.
4. **교착상태**는 요청한 리소스가 다른 프로세스에 의해 차단되지만, **기아현상**은 요청된 리소스가 우선순위가 더 높은 프로세스에서 계속 사용되는 것이다.
5. **교착상태**는 상호 배제, 보류 및 대기, 선점 없음, 순환 대기가 동시에 발생할 때 발생하지만, **기아현상**은 통제되지 않은 우선순위와 자원 관리로 인해 발생한다.

**교착 상태에 필요한 조건**

1. Mutual Exclusions(상호 배제)
   - 리소스는 상호 배타적인 방식으로만 공유 가능, 두 프로세스가 동시에 동일한 리소스를 사용할 수 없는 경우를 의미
2. Hold and Wait (보류 및 대기)
   - 프로세스는 다른 리소스를 동시에 보유하면서 필요한 다른 리소스를 기다린다.
3. No preemption(선점 없음)
   - 한 번 예약된 프로세스는 완료될 때까지 실행이 된다. 그 동안 스케쥴러는 다른 프로세스를 예약할 수 있다.
4. Circular Wait(순환 대기)
   - 마지막 프로세스가 첫 번째 프로세스가 보유하고 있는 자원을 기다리도록 모든 프로세스는 순환 방식으로 자원을 대기 하고 있다.

## 2. 자원 할당 그래프 (Resource Allocation Graph)를 사용해서 Deadlock을 표현해주세요

- 자원 할당 그래프는 시스템 상태를 그림으로 나타낸 것이다. 이름에서 알 수 있듯 리소스 할당 그래프는 일부 리소스를 보유하거나 일부 리소스를 기다리는 모든 프로세스에 대한 완전한 정보이다.
- 이것은 또한 모든 자원의 인스턴스 정보를 포함한다. 그것들이 가용가능한 상태이거나, 어떤 프로세스에 의해 사용되고 있는 상태이거나 둘 다 포함된다.

- 자원 할당 그래프에서는 프로세스는 원으로 표현되고 자원은 직사각형으로 표현된다.

  ![image-20210905155708316](/Users/samuel/Library/Application Support/typora-user-images/image-20210905155708316.png)

- Vertex들은 주로 두가지 타입인데, 자원과 프로세스다. 각각 다른 형태로 표현되고 있다.

- 자원은 하나 이상의 인스턴스를 가질 수 있도 각 인스턴스들은 직사각형 안에 점으로 표현된다.

- Edge도 두 가지 유형으로 나뉜다. 하나는 할당 다른 하나는 프로세스의 대기를 나타낸다. 

  - 화살표 꼬리 부분이 리소스에 대한 인스턴스에 연결되고 머리 부분이 프로세스에 연결된 경우 리소스는 해당 프로세스에 할당 된 것으로 표시한다.

  - 머리가 리소스를 가리키고 있는 동안 화살표의 꼬리가 프로세스에 연결되어 있으면 프로세스가 리소스를 기다리는 것으로 표시된다.

    ![image-20210905160017377](/Users/samuel/Library/Application Support/typora-user-images/image-20210905160017377.png)

**예시 )**

![image-20210905160115724](/Users/samuel/Library/Application Support/typora-user-images/image-20210905160115724.png)

- 사이클이 형성되지 않기 때문에 그래프는 교착상태가 아니다.

**교착상태 그래프**

![image-20210905160311307](/Users/samuel/Library/Application Support/typora-user-images/image-20210905160311307.png)

모든 리소스에 단일 인스턴스가 있는 리소스 할당 그래프에서 주기가 형성되면 시스템이 교착 상태가 된다. 다중 인스턴스 자원 유형의 자원 할당 그래프의 경우 주기는 교착상태의 필요 조건이지만 충분 조건은 아니다. 교착상태의 4가지 조건을 모두 만족하는 위 그래프는 사이클이 형성되어 있음을 알수 있다

## 3. Deadlock을 다루기 위한 방법(Ignorance, Prevention, ...)은 이와 같이 여러가지가 있는데 각각의 장단점은 무엇이고, 어떤 방법이 가장 많이 쓰이고 있는 지, 왜 많이 쓰이는 지 알려주세요.

### Deadlock Prevention

#### (1) Mutual Exclusion(상호배제)

리소스 관점에서 리소스는 둘 이상의 프로세스에 동시에 사용될 수 없다. 그런데, 이게 교착 상태의 주요 원인이 된다. 자원이 둘 이상의 프로세스에서 사용 될 수 있었으면, 프로세스는 자원을 위해 기다리지 않았을 것이다. 그러나 만약 우리가 리소스를 상호배제에 있는 자원을 위반할 수 있으면 데드락을 막을 수 있다.

##### spolling

프린터 같은 장치들, 스풀링이 작동한다. 각 프로세스의 작업을 프린터에 저장하는 프린터와 관련된 메모리가 있다. 프린터는 모든 작업을 수업하고 FCFS에 따라 각 직업을 수행해 나가는데, 이 메커니즘을 사용하면 프로세스가 프린터를 기다릴 필요가 없으며 수행하던 작업을 계속할 수 있다. 

그러나, 스풀링은 상호 배제를 위반하는 효과적인 접근 방식이 될 수 있지만 문제가 있다.![image-20210905165305658](/Users/samuel/Library/Application Support/typora-user-images/image-20210905165305658.png)

1. 모든 리소스에 적용 불가
2. 일정 시간이 지나면 해당 스풀에 공간을 확보하기 위한 프로세스 간 경쟁조건이 발생할 수 있다.

리소스가 공정하지 않고 성능에 문제가 발생할 수 있어서 동시에 둘 이상의 프로세스에서 리소스를 사용하도록 강제할 수가 없다. 따라서 실질적으로 프로세스에 대한 상호배제를 위반할 수 없다.

#### (2) Hold and Wait

보류 대기 조건은 프로세스가 리소스를 보유하고 다른 리소스가 작업을 완료하기를 기다리는 경우를 말하는데, 교착 상태는 순환 순서로 하나의 자원을 보유하고 다른 자원을 기다리는 프로세스가 둘 이상 있을 수 있기 때문에 발생한다.

그럼 교착상태를 막기위해 프로세스가 리소스를 보유하지 않거나 기다리지 않는 메커니즘을 찾아야 하는데

실행이 되기 전에 프로세스에 필요한 모든 리소스가 할당 되는 방법이 있고, 이 말은 즉  프로세스가 실행이 되면 리소스를 기다리지 않게끔 하는 방법이다.

근데 프로세스가 초기에 모든 자원을 선언해주어야 하는데 프로세스가 초기에 필요한 리소스를 어떻게 결정하나? 컴퓨터 시스템에서는 수행할 수 없겠다.

#### (3) No Preemption

교착상태는 프로세스 시작시 멈출 수 없기 때문에 발생한다. 그러나 교착상태를 유발하는 프로세스에서 리소스를 제거하면 교착 상태를 방지할 수 있게 된다. 

근데, 프로세스에서 사용중인 리소스를 제거하면 그때까지 수행한 작업들의 일관성이 무너진다. 

비효율의 표상, 100% 성능 저하 보장!! 

#### (4) Circular wait

순환 대기를 위반하기 위해 각 리소스에 우선 순위 번호를 할당할 수 있다. 프로세스는 우선 순위가 낮은 리소스를 요청할 수 없다. 이렇게 하면 일단 단일 프로세스가 다른 프로세스에서 사용 중인 리소스를 요청할 수 없게 되고, 사이클이 형성되지 않게 된다. 

![image-20210905170309884](/Users/samuel/Library/Application Support/typora-user-images/image-20210905170309884.png)

모든 방법중 4번 방법이 실질적으로 구현할 수 있는 유일한 방법이다.



